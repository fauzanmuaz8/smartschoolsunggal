<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Laporan Tugas Pegawai - Smart TU</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { background: #f8f9fa; }
    .preview-img { width: 70px; height: 50px; object-fit: cover; border-radius: 4px; }
    .monitor-section { max-height: 400px; overflow-y: auto; }
  </style>
</head>
<body>
  <div class="container my-4">
    <h2 class="mb-4 text-primary text-center">Form Input Laporan Tugas Pegawai</h2>
    <form id="formTugas" class="bg-white p-4 rounded shadow-sm">
      <div class="mb-3">
        <label for="nama" class="form-label">Nama Pegawai</label>
        <input type="text" id="nama" class="form-control" required placeholder="Masukkan nama pegawai" />
      </div>
      <div class="mb-3">
        <label for="tanggal" class="form-label">Tanggal Tugas</label>
        <input type="date" id="tanggal" class="form-control" required />
      </div>
      <div class="row g-3 mb-3">
        <div class="col-md-6">
          <label for="jamMulai" class="form-label">Jam Mulai</label>
          <input type="time" id="jamMulai" class="form-control" required />
        </div>
        <div class="col-md-6">
          <label for="jamSelesai" class="form-label">Jam Selesai</label>
          <input type="time" id="jamSelesai" class="form-control" required />
        </div>
      </div>
      <div class="mb-3">
        <label for="tugas" class="form-label">Uraian Tugas</label>
        <textarea id="tugas" class="form-control" rows="3" required placeholder="Tuliskan uraian tugas"></textarea>
      </div>
      <div class="mb-3">
        <label for="foto" class="form-label">Upload Foto (Opsional)</label>
        <input type="file" id="foto" class="form-control" accept="image/*" />
        <small class="form-text text-muted">Foto akan dikompres otomatis.</small>
      </div>
      <button type="submit" class="btn btn-primary w-100">Simpan Laporan</button>
    </form>

    <hr class="my-5" />

    <div class="d-flex justify-content-between align-items-center mb-3">
      <h4 class="text-success">ðŸ“Š Monitoring Tugas (Kepsek)</h4>
      <div class="dropdown">
        <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
          Ekspor Laporan
        </button>
        <ul class="dropdown-menu">
          <li><a class="dropdown-item" href="#" id="exportExcel">Download Excel</a></li>
          <li><a class="dropdown-item" href="#" id="exportPDF">Download PDF</a></li>
          <li><hr class="dropdown-divider"></li>
          <li><a class="dropdown-item" href="#" id="backupDB">Backup Database (JSON)</a></li>
          <li><a class="dropdown-item" href="#" id="resetDB">Reset Semua Tugas</a></li>
        </ul>
      </div>
    </div>

    <div class="mb-3">
      <label for="importJsonFile" class="form-label">Import Database (JSON):</label>
      <input type="file" id="importJsonFile" accept=".json" class="form-control" />
    </div>

    <div class="monitor-section bg-white p-3 rounded shadow-sm">
      <table class="table table-striped table-hover align-middle" id="tabelLaporan">
        <thead class="table-dark">
          <tr>
            <th>Nama</th>
            <th>Tanggal</th>
            <th>Jam</th>
            <th>Uraian Tugas</th>
            <th>Foto</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

  <!-- SheetJS -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/shim.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

  <!-- jsPDF and html2canvas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    // ======== KONFIGURASI FIREBASE ========
    const firebaseConfig = {
  apiKey: "AIzaSyBs3R8J9H6hQ96_Cm2WhWduPCK-uWJSzUo",
  authDomain: "loginsmartschool-4f57d.firebaseapp.com",
  databaseURL: "https://loginsmartschool-4f57d-default-rtdb.firebaseio.com",
  projectId: "loginsmartschool-4f57d",
  storageBucket: "loginsmartschool-4f57d.firebasestorage.app",
  messagingSenderId: "166215127727",
  appId: "1:166215127727:web:6888450f047c203871fa5a",
  measurementId: "G-8ZWH6QBTFV"
};
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ======== FUNGSI KOMPRESI FOTO ========
    async function kompresFoto(file) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (event) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement("canvas");
            const maxWidth = 800;
            const maxHeight = 600;
            let width = img.width;
            let height = img.height;

            if (width > height) {
              if (width > maxWidth) {
                height *= maxWidth / width;
                width = maxWidth;
              }
            } else {
              if (height > maxHeight) {
                width *= maxHeight / height;
                height = maxHeight;
              }
            }

            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0, width, height);
            canvas.toBlob((blob) => {
              resolve(blob);
            }, "image/jpeg", 0.7);
          };
          img.src = event.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    // ======== FUNGSI SIMPAN LAPORAN ========
    const form = document.getElementById("formTugas");
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const nama = document.getElementById("nama").value.trim();
      const tanggal = document.getElementById("tanggal").value;
      const jamMulai = document.getElementById("jamMulai").value;
      const jamSelesai = document.getElementById("jamSelesai").value;
      const tugas = document.getElementById("tugas").value.trim();
      const fotoInput = document.getElementById("foto");

      if (jamMulai >= jamSelesai) {
        alert("Jam selesai harus lebih besar dari jam mulai!");
        return;
      }

      let fotoURL = "";
      if (fotoInput.files.length > 0) {
        const file = fotoInput.files[0];
        const compressedBlob = await kompresFoto(file);
        fotoURL = await uploadFoto(compressedBlob);
      }

      // Simpan ke Firebase Realtime Database
      const newRef = db.ref("laporan").push();
      await newRef.set({
        nama,
        tanggal,
        jamMulai,
        jamSelesai,
        tugas,
        foto: fotoURL
      });

      alert("Laporan berhasil disimpan!");
      form.reset();
    });

    // ======== UPLOAD FOTO KE STORAGE SIMPLIFIED DUMMY (SIMULASI) ========
    // Karena Firebase Storage belum dikonfig, upload foto disimulasikan dengan Data URL
    // Jika ingin pakai Storage Firebase, harus setup Storage terlebih dahulu.
    async function uploadFoto(blob) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = () => {
          resolve(reader.result); // simpan base64 sebagai URL sementara
        };
        reader.readAsDataURL(blob);
      });
    }

    // ======== LOAD DATA LAPORAN & TAMPILKAN ========
    const tbody = document.querySelector("#tabelLaporan tbody");

    function loadLaporan() {
      db.ref("laporan").on("value", (snapshot) => {
        tbody.innerHTML = "";
        snapshot.forEach((child) => {
          const data = child.val();
          const jam = (data.jamMulai || '-') + " s/d " + (data.jamSelesai || '-');
          const row = `
            <tr>
              <td>${data.nama}</td>
              <td>${data.tanggal}</td>
              <td>${jam}</td>
              <td>${data.tugas}</td>
              <td>${data.foto ? `<a href="${data.foto}" target="_blank"><img src="${data.foto}" class="preview-img"></a>` : "-"}</td>
            </tr>
          `;
          tbody.innerHTML += row;
        });
      });
    }
    loadLaporan();

    // ======== EXPORT TO EXCEL ========
    document.getElementById("exportExcel").addEventListener("click", () => {
      db.ref("laporan").once("value").then((snap) => {
        const rows = [["Nama", "Tanggal", "Jam", "Uraian Tugas", "Link Foto"]];
        snap.forEach((child) => {
          const d = child.val();
          const jam = (d.jamMulai || '-') + " s/d " + (d.jamSelesai || '-');
          rows.push([d.nama, d.tanggal, jam, d.tugas, d.foto || ""]);
        });
        const ws = XLSX.utils.aoa_to_sheet(rows);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Laporan");
        XLSX.writeFile(wb, "Laporan_Tugas.xlsx");
      });
    });

    // ======== EXPORT TO PDF ========
    document.getElementById("exportPDF").addEventListener("click", () => {
      const element = document.querySelector(".monitor-section");
      html2canvas(element).then((canvas) => {
        const imgData = canvas.toDataURL("image/png");
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF("p", "mm", "a4");
        const imgProps = pdf.getImageProperties(imgData);
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
        pdf.addImage(imgData, "PNG", 0, 10, pdfWidth, pdfHeight);
        pdf.save("Laporan_Tugas.pdf");
      });
    });

    // ======== BACKUP DATABASE JSON ========
    document.getElementById("backupDB").addEventListener("click", () => {
      db.ref("laporan").once("value").then((snap) => {
        const data = snap.val() || {};
        const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `backup-laporan-${new Date().toISOString().slice(0,10)}.json`;
        a.click();
        URL.revokeObjectURL(url);
      });
    });

    // ======== IMPORT DATABASE JSON ========
    document.getElementById("importJsonFile").addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return alert("Pilih file JSON terlebih dahulu!");
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const jsonData = JSON.parse(reader.result);
          if (typeof jsonData !== "object") throw new Error("Format JSON salah!");
          // Simpan data ke firebase (replace)
          db.ref("laporan").set(jsonData).then(() => {
            alert("Data berhasil diimport!");
            e.target.value = "";
          });
        } catch (err) {
          alert("Gagal import JSON: " + err.message);
        }
      };
      reader.readAsText(file);
    });

    // ======== RESET DATABASE DENGAN KODE ========
    document.getElementById("resetDB").addEventListener("click", () => {
      const kode = prompt("Masukkan kode reset:");
      if (kode === "5UGJV99QQT") {
        if (confirm("Yakin ingin menghapus semua data tugas? Tindakan ini tidak dapat dibatalkan!")) {
          db.ref("laporan").remove()
            .then(() => alert("Semua data tugas berhasil dihapus!"))
            .catch(err => alert("Gagal menghapus data: " + err.message));
        }
      } else {
        alert("Kode reset salah!");
      }
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
