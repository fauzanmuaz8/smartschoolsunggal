<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Laporan & Rekap BK</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body class="bg-light">
<div class="container py-4">
  <h2 class="text-center text-primary mb-4">üìä Laporan & Rekap BK</h2>

  <div class="row mb-3">
    <div class="col-md-3">
      <select id="kategori" class="form-select" onchange="tampilkanData()">
        <option value="semua">üìÅ Semua Data</option>
        <option value="permintaan">üì© Permintaan Konseling</option>
        <option value="jadwal">üìÖ Jadwal Konseling</option>
        <option value="riwayat">üìñ Riwayat Konseling</option>
        <option value="catatan">üìò Catatan Siswa</option>
      </select>
    </div>
    <div class="col-md-3">
      <input type="text" id="filterNama" class="form-control" placeholder="Cari Nama Siswa" onkeyup="tampilkanData()">
    </div>
    <div class="col-md-3">
      <input type="text" id="filterKelas" class="form-control" placeholder="Cari Kelas" onkeyup="tampilkanData()">
    </div>
    <div class="col-md-3">
      <button class="btn btn-success w-100" onclick="exportExcel()">‚¨áÔ∏è Export Excel</button>
    </div>
  </div>

  <div class="d-flex justify-content-end mb-2">
    <button class="btn btn-danger" onclick="exportPDF()">‚¨áÔ∏è Export PDF</button>
  </div>

  <div class="table-responsive" id="laporanArea">
    <table class="table table-bordered table-striped text-center">
      <thead class="table-info">
        <tr id="theadLaporan"></tr>
      </thead>
      <tbody id="tbodyLaporan"></tbody>
    </table>
  </div>
</div>

<script>
  const firebaseConfig = {
  apiKey: "AIzaSyBs3R8J9H6hQ96_Cm2WhWduPCK-uWJSzUo",
  authDomain: "loginsmartschool-4f57d.firebaseapp.com",
  databaseURL: "https://loginsmartschool-4f57d-default-rtdb.firebaseio.com",
  projectId: "loginsmartschool-4f57d",
  storageBucket: "loginsmartschool-4f57d.firebasestorage.app",
  messagingSenderId: "166215127727",
  appId: "1:166215127727:web:6888450f047c203871fa5a",
  measurementId: "G-8ZWH6QBTFV"
};
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  async function tampilkanData() {
    const kategori = document.getElementById("kategori").value;
    const nama = document.getElementById("filterNama").value.toLowerCase();
    const kelas = document.getElementById("filterKelas").value.toLowerCase();
    const tbody = document.getElementById("tbodyLaporan");
    const thead = document.getElementById("theadLaporan");
    tbody.innerHTML = "";
    thead.innerHTML = "";

    let refPath = "";
    let header = [];

    if (kategori === "permintaan") {
      refPath = "permintaan_konseling";
      header = ["Nama", "Kelas", "Topik", "Tanggal", "Jam", "Status"];
    } else if (kategori === "jadwal") {
      refPath = "jadwal_konseling";
      header = ["Hari", "Jam", "Kelas", "Siswa", "Topik"];
    } else if (kategori === "riwayat") {
      refPath = "jadwal_konseling";
      header = ["Hari", "Jam", "Kelas", "Siswa", "Topik", "Status"];
    } else if (kategori === "catatan") {
      refPath = "catatan_siswa";
      header = ["Nama", "Kelas", "Tanggal", "Kategori", "Catatan"];
    }

    if (kategori === "semua") {
      tbody.innerHTML = `<tr><td colspan='10'>Silakan pilih kategori untuk melihat laporan.</td></tr>`;
      return;
    }

    header.forEach(h => thead.innerHTML += `<th>${h}</th>`);

    db.ref(refPath).once("value", snapshot => {
      snapshot.forEach(child => {
        const data = child.val();
        if ((data.nama || data.siswa || "").toLowerCase().includes(nama) === false) return;
        if ((data.kelas || "").toLowerCase().includes(kelas) === false) return;
        if (kategori === "riwayat" && data.status !== "Selesai") return;

        const tr = document.createElement("tr");
        let isi = "";
        if (kategori === "permintaan") {
          isi = `<td>${data.nama}</td><td>${data.kelas}</td><td>${data.topik}</td><td>${data.tanggal}</td><td>${data.jam}</td><td>${data.status}</td>`;
        } else if (kategori === "jadwal") {
          isi = `<td>${data.hari}</td><td>${data.jam}</td><td>${data.kelas}</td><td>${data.siswa}</td><td>${data.topik}</td>`;
        } else if (kategori === "riwayat") {
          isi = `<td>${data.hari}</td><td>${data.jam}</td><td>${data.kelas}</td><td>${data.siswa}</td><td>${data.topik}</td><td>${data.status}</td>`;
        } else if (kategori === "catatan") {
          isi = `<td>${data.nama}</td><td>${data.kelas}</td><td>${data.tanggal}</td><td>${data.kategori}</td><td>${data.catatan}</td>`;
        }
        tr.innerHTML = isi;
        tbody.appendChild(tr);
      });
    });
  }

  function exportExcel() {
    let table = document.querySelector("table").outerHTML;
    let data = `
      <html xmlns:o="urn:schemas-microsoft-com:office:office"
            xmlns:x="urn:schemas-microsoft-com:office:excel"
            xmlns="http://www.w3.org/TR/REC-html40">
      <head><meta charset="UTF-8"></head><body>${table}</body></html>`;
    let blob = new Blob([data], { type: "application/vnd.ms-excel" });
    let url = URL.createObjectURL(blob);
    let a = document.createElement("a");
    a.href = url;
    a.download = "laporan_bk.xls";
    a.click();
    URL.revokeObjectURL(url);
  }

  async function exportPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('landscape');
    const laporan = document.getElementById("laporanArea");
    const canvas = await html2canvas(laporan);
    const imgData = canvas.toDataURL("image/png");
    const imgProps= doc.getImageProperties(imgData);
    const pdfWidth = doc.internal.pageSize.getWidth();
    const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
    doc.addImage(imgData, 'PNG', 0, 10, pdfWidth, pdfHeight);
    doc.save("laporan_bk.pdf");
  }

  window.onload = tampilkanData;
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>