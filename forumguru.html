<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Forum Guru SMAN 1 Sunggal</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBs3R8J9H6hQ96_Cm2WhWduPCK-uWJSzUo",
      authDomain: "loginsmartschool-4f57d.firebaseapp.com",
      databaseURL: "https://loginsmartschool-4f57d-default-rtdb.firebaseio.com",
      projectId: "loginsmartschool-4f57d",
      storageBucket: "loginsmartschool-4f57d.appspot.com",
      messagingSenderId: "166215127727",
      appId: "1:166215127727:web:6888450f047c203871fa5a",
      measurementId: "G-8ZWH6QBTFV"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const storage = getStorage(app);

    let isAdmin = false;
    const kodeAdmin = "5UGJV99QQT";

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("btnKirim").addEventListener("click", kirimDiskusi);
      document.getElementById("btnAdmin").addEventListener("click", verifikasiKode);
      tampilkanForum();
    });

    function verifikasiKode() {
      const kode = document.getElementById("adminCode").value;
      if (kode === kodeAdmin) {
        isAdmin = true;
        alert("Mode admin aktif");
      } else {
        alert("Kode salah");
      }
    }

    function kirimDiskusi() {
      const nama = document.getElementById("namaGuru").value;
      const mapel = document.getElementById("mapel").value;
      const topik = document.getElementById("topik").value;
      const isi = document.getElementById("isiDiskusi").value;
      const file = document.getElementById("fileDokumen").files[0];
      const waktu = new Date().toLocaleString();
      const postRef = ref(db, "forum/");

      if (file) {
        const storageRef = sRef(storage, 'dokumen/' + Date.now() + '_' + file.name);
        uploadBytes(storageRef, file).then(snapshot => {
          getDownloadURL(snapshot.ref).then(url => {
            push(postRef, { nama, mapel, topik, isi, waktu, dokumen: url, balasan: [] });
          });
        });
      } else {
        push(postRef, { nama, mapel, topik, isi, waktu, dokumen: "", balasan: [] });
      }
    }

    function kirimBalasan(id, isiBalasan) {
      const balasanRef = ref(db, `forum/${id}/balasan`);
      const data = { nama: "Guru", isi: isiBalasan, waktu: new Date().toLocaleString() };
      push(balasanRef, data);
    }

    function tampilkanForum() {
      const wadah = document.getElementById("daftarForum");
      const postRef = ref(db, "forum");
      onValue(postRef, snapshot => {
        const data = snapshot.val();
        wadah.innerHTML = "";
        for (let id in data) {
          const f = data[id];
          const daftarBalasan = f.balasan ? Object.values(f.balasan).map(b => `<div class='bg-white p-2 mt-1 rounded'><strong>${b.nama}</strong>: ${b.isi} <small class='text-muted'>(${b.waktu})</small></div>`).join('') : "";
          wadah.innerHTML += `
            <div class='mb-4 p-3 bg-light rounded'>
              <strong>${f.nama}</strong> - ${f.mapel} - ${f.topik} <br><small>${f.waktu}</small>
              <p>${f.isi}</p>
              ${f.dokumen ? `<a href="${f.dokumen}" target="_blank">Lihat Dokumen</a>` : ""}
              <div>${daftarBalasan}</div>
              <div class="input-group mt-2">
                <input class="form-control" placeholder="Balas..." id="balasan-${id}">
                <button class="btn btn-sm btn-secondary" onclick="kirimBalasan('${id}', document.getElementById('balasan-${id}').value)">Kirim</button>
              </div>
              ${isAdmin ? `<button class="btn btn-sm btn-danger mt-2" onclick="hapusPost('${id}')">Hapus</button>` : ""}
            </div>
          `;
        }
      });
    }

    window.hapusPost = function(id) {
      if (isAdmin) {
        remove(ref(db, 'forum/' + id));
      } else {
        alert("Masukkan kode admin terlebih dahulu");
      }
    }

    window.kirimBalasan = kirimBalasan;
  </script>
  <style>
    body {
      background-color: #0d6efd;
      font-family: 'Segoe UI', sans-serif;
      color: white;
    }
    .card {
      border-radius: 15px;
    }
    .bg-forum {
      background-color: #f8f9fa;
      color: #000;
    }
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      height: 100%;
      width: 250px;
      background: #ffffff;
      color: black;
      padding: 20px;
      overflow-y: auto;
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
    }
    .main-content {
      margin-left: 270px;
    }
  </style>
</head>
<body>
<div class="sidebar">
  <h5 class="text-primary">Forum Guru</h5>
  <input type="password" class="form-control mb-2" id="adminCode" placeholder="Kode Admin">
  <button class="btn btn-sm btn-primary w-100" id="btnAdmin">Mode Admin</button>
</div>

<div class="main-content">
  <div class="container py-5">
    <div class="text-center mb-4">
      <h2>Forum Guru SMAN 1 Sunggal</h2>
      <p class="lead">Diskusi, Balasan, dan Berbagi Dokumen</p>
    </div>

    <div class="card p-4 mb-4">
      <h5 class="text-dark">Tulis Diskusi Baru</h5>
      <input type="text" class="form-control mb-2" id="namaGuru" placeholder="Nama Guru">
      <input type="text" class="form-control mb-2" id="mapel" placeholder="Mata Pelajaran">
      <input type="text" class="form-control mb-2" id="topik" placeholder="Topik Diskusi">
      <textarea class="form-control mb-2" id="isiDiskusi" rows="3" placeholder="Tulis isi diskusi..."></textarea>
      <input type="file" class="form-control mb-3" id="fileDokumen">
      <button class="btn btn-primary" id="btnKirim">Kirim</button>
    </div>

    <div class="card p-4 bg-forum">
      <h5>Diskusi Terbaru</h5>
      <div id="daftarForum"></div>
    </div>
  </div>
</div>
</body>
</html>
