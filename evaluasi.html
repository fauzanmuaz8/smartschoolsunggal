<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Evaluasi Siswa - Firebase</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-light">

<div class="container py-4">
  <h3 class="text-center mb-4">ğŸ“š Evaluasi Siswa - Firebase</h3>

  <div class="text-end mb-2">
    <button class="btn btn-sm btn-warning" onclick="aktifkanEditRahasia()">ğŸ” Admin Mode</button>
  </div>

  <div class="row mb-3">
    <div class="col-md-2">
      <label class="form-label">Tanggal</label>
      <input type="date" id="tanggal" class="form-control" />
    </div>
    <div class="col-md-3">
      <label class="form-label">Guru</label>
      <select id="guru" class="form-select"></select>
      <input type="text" id="tambahGuru" class="form-control mt-1" placeholder="Tambah Guru" disabled>
      <button onclick="tambahGuru()" class="btn btn-sm btn-outline-primary mt-1 w-100" id="btnGuru" disabled>Tambah</button>
    </div>
    <div class="col-md-3">
      <label class="form-label">Kelas</label>
      <select id="kelas" class="form-select"></select>
      <input type="text" id="tambahKelas" class="form-control mt-1" placeholder="Tambah Kelas" disabled>
      <button onclick="tambahKelas()" class="btn btn-sm btn-outline-success mt-1 w-100" id="btnKelas" disabled>Tambah</button>
    </div>
    <div class="col-md-2">
      <label class="form-label">Filter Kelas</label>
      <select id="filterKelas" class="form-select" onchange="renderTable()">
        <option value="">Semua</option>
      </select>
    </div>
    <div class="col-md-2">
      <label class="form-label">&nbsp;</label>
      <button onclick="window.print()" class="btn btn-secondary w-100">ğŸ–¨ï¸ Cetak</button>
    </div>
  </div>

  <div class="row g-2 align-items-end mb-3">
    <div class="col-md-4">
      <label class="form-label">Nama Siswa</label>
      <input type="text" id="nama" class="form-control" oninput="this.value = this.value.toUpperCase()" />
    </div>
    <div class="col-md-5">
      <label class="form-label">Catatan Evaluasi</label>
      <input type="text" id="catatan" class="form-control" />
    </div>
    <div class="col-md-3">
      <button onclick="tambahData()" class="btn btn-primary w-100">+ Tambah Data</button>
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-bordered table-striped" id="tabelData">
      <thead class="table-dark">
        <tr>
          <th>Tanggal</th>
          <th>Guru</th>
          <th>Kelas</th>
          <th>Nama Siswa</th>
          <th>Catatan</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="d-flex gap-2">
    <button onclick="exportExcel()" class="btn btn-success">ğŸ’¾ Export Excel</button>
    <button onclick="exportPDF()" class="btn btn-danger">ğŸ“„ Export PDF</button>
  </div>
</div>

<script>
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyBs3R8J9H6hQ96_Cm2WhWduPCK-uWJSzUo",
    authDomain: "loginsmartschool-4f57d.firebaseapp.com",
    databaseURL: "https://loginsmartschool-4f57d-default-rtdb.firebaseio.com",
    projectId: "loginsmartschool-4f57d",
    storageBucket: "loginsmartschool-4f57d.firebasestorage.app",
    messagingSenderId: "166215127727",
    appId: "1:166215127727:web:6888450f047c203871fa5a",
    measurementId: "G-8ZWH6QBTFV"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const guruSelect = document.getElementById('guru');
  const kelasSelect = document.getElementById('kelas');
  const filterKelas = document.getElementById('filterKelas');

  function aktifkanEditRahasia() {
    const kode = prompt("Masukkan Kode Akses:");
    if (kode === "5UGJV99QQT") {
      document.getElementById("tambahGuru").disabled = false;
      document.getElementById("btnGuru").disabled = false;
      document.getElementById("tambahKelas").disabled = false;
      document.getElementById("btnKelas").disabled = false;
      alert("Mode edit aktif!");
    } else {
      alert("Kode salah. Akses ditolak.");
    }
  }

  function tambahGuru() {
    const val = document.getElementById('tambahGuru').value.trim().toUpperCase();
    if (val) {
      guruSelect.add(new Option(val, val));
      document.getElementById('tambahGuru').value = '';
    }
  }

  function tambahKelas() {
    const val = document.getElementById('tambahKelas').value.trim().toUpperCase();
    if (val) {
      kelasSelect.add(new Option(val, val));
      filterKelas.add(new Option(val, val));
      document.getElementById('tambahKelas').value = '';
    }
  }

  function tambahData() {
    const tanggal = document.getElementById('tanggal').value;
    const guru = guruSelect.value;
    const kelas = kelasSelect.value;
    const nama = document.getElementById('nama').value.trim().toUpperCase();
    const catatan = document.getElementById('catatan').value;

    if (!tanggal || !guru || !kelas || !nama || !catatan) return alert("Semua field wajib diisi!");

    const newRef = db.ref('evaluasi').push();
    const row = { id: newRef.key, tanggal, guru, kelas, nama, catatan };
    newRef.set(row);
    document.getElementById('nama').value = '';
    document.getElementById('catatan').value = '';
  }

  function renderTable() {
    db.ref('evaluasi').once('value', snap => {
      const tbody = document.querySelector("#tabelData tbody");
      tbody.innerHTML = '';
      const filter = filterKelas.value;
      const rows = [];
      snap.forEach(child => {
        const val = child.val();
        if (!filter || val.kelas === filter) {
          rows.push(val);
        }
      });

      rows.forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row.tanggal}</td>
          <td>${row.guru}</td>
          <td>${row.kelas}</td>
          <td>${row.nama}</td>
          <td>${row.catatan}</td>
          <td>
            <button class="btn btn-sm btn-warning me-1" onclick="editData('${row.id}')">Edit</button>
            <button class="btn btn-sm btn-danger" onclick="hapusData('${row.id}')">Hapus</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    });
  }

  function editData(id) {
    const nama = prompt("Edit Nama Siswa:");
    const catatan = prompt("Edit Catatan Evaluasi:");
    if (nama && catatan) {
      db.ref('evaluasi/' + id).update({ nama: nama.toUpperCase(), catatan });
      renderTable();
    }
  }

  function hapusData(id) {
    if (confirm("Hapus data ini?")) {
      db.ref('evaluasi/' + id).remove();
      renderTable();
    }
  }

  function exportExcel() {
    db.ref('evaluasi').once('value', snap => {
      const rows = [];
      snap.forEach(child => rows.push(child.val()));
      const ws = XLSX.utils.json_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Evaluasi");
      XLSX.writeFile(wb, "evaluasi_siswa.xlsx");
    });
  }

  async function exportPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.text("Rekap Evaluasi Siswa", 10, 10);
    let y = 20;

    const snap = await db.ref('evaluasi').once('value');
    let i = 1;
    snap.forEach(child => {
      const r = child.val();
      doc.text(`${i++}. ${r.tanggal} | ${r.guru} | ${r.kelas} | ${r.nama} | ${r.catatan}`, 10, y);
      y += 10;
      if (y > 270) {
        doc.addPage();
        y = 20;
      }
    });

    doc.save("evaluasi_siswa.pdf");
  }

  window.onload = () => {
    ["PAK BUDI", "BU INA", "PAK YUSUF"].forEach(n => guruSelect.add(new Option(n, n)));
    ["X IPA 1", "XI IPA 2", "XII IPS 3"].forEach(k => {
      kelasSelect.add(new Option(k, k));
      filterKelas.add(new Option(k, k));
    });
    renderTable();
  };
</script>

</body>
</html>
