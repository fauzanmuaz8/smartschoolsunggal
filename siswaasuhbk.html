<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Daftar Siswa Asuh BK</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Bootstrap + Animate CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <style>
    body {
      background: linear-gradient(to bottom, #001f3f, #003366);
      color: white;
      min-height: 100vh;
    }
    .card {
      background-color: rgba(255, 255, 255, 0.1);
      border: none;
      backdrop-filter: blur(8px);
    }
    table, th, td {
      color: white;
    }
    .form-control, .btn {
      border-radius: 10px;
    }
    .btn-kode {
      margin-top: 5px;
    }
  </style>
</head>
<body class="p-3 animate__animated animate__fadeIn">

  <div class="container">
    <h3 class="text-center mb-4">Daftar Siswa Asuh BK</h3>

    <div class="card p-3 mb-3">
      <div class="row g-2">
        <div class="col-md-4">
          <select id="kelasFilter" class="form-control">
            <option value="">-- Pilih Kelas --</option>
          </select>
        </div>
        <div class="col-md-4">
          <input type="file" id="excelFile" accept=".xlsx" class="form-control">
        </div>
        <div class="col-md-4 d-grid">
          <button class="btn btn-success" onclick="importExcel()">Import Siswa</button>
        </div>
        <div class="col-md-6 mt-2">
          <button class="btn btn-warning" onclick="downloadFormat()">Download Format Excel</button>
        </div>
        <div class="col-md-6 mt-2">
          <input type="password" class="form-control" id="kodeAkses" placeholder="Masukkan kode akses">
        </div>
        <div class="col-md-6 mt-2 d-grid">
          <button class="btn btn-danger" onclick="hapusSiswa()">Hapus Siswa</button>
        </div>
        <div class="col-md-6 mt-2 d-grid">
          <button class="btn btn-danger" onclick="hapusKelas()">Hapus Kelas</button>
        </div>
      </div>
    </div>

    <table class="table table-bordered table-striped mt-3">
      <thead>
        <tr>
          <th>Nama Siswa</th>
          <th>Kelas</th>
        </tr>
      </thead>
      <tbody id="dataTabel"></tbody>
    </table>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBs3R8J9H6hQ96_Cm2WhWduPCK-uWJSzUo",
      authDomain: "loginsmartschool-4f57d.firebaseapp.com",
      databaseURL: "https://loginsmartschool-4f57d-default-rtdb.firebaseio.com",
      projectId: "loginsmartschool-4f57d",
      storageBucket: "loginsmartschool-4f57d.appspot.com",
      messagingSenderId: "166215127727",
      appId: "1:166215127727:web:6888450f047c203871fa5a"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const guruLogin = localStorage.getItem("guru") || "fery"; // default fery jika belum login
    const kelasDropdown = document.getElementById("kelasFilter");
    const tabelBody = document.getElementById("dataTabel");

    function tampilkanData(kelas) {
      tabelBody.innerHTML = "";
      db.ref("siswa_asuh").orderByChild("guru").equalTo(guruLogin).once("value", snapshot => {
        snapshot.forEach(child => {
          const data = child.val();
          if (!kelas || data.kelas === kelas) {
            const row = `<tr><td>${data.nama}</td><td>${data.kelas}</td></tr>`;
            tabelBody.innerHTML += row;
          }
        });
      });
    }

    function loadKelas() {
      kelasDropdown.innerHTML = `<option value="">-- Semua Kelas --</option>`;
      const kelasSet = new Set();
      db.ref("siswa_asuh").orderByChild("guru").equalTo(guruLogin).once("value", snapshot => {
        snapshot.forEach(child => {
          kelasSet.add(child.val().kelas);
        });
        kelasSet.forEach(kls => {
          const opt = document.createElement("option");
          opt.value = kls;
          opt.textContent = kls;
          kelasDropdown.appendChild(opt);
        });
      });
    }

    kelasDropdown.addEventListener("change", e => tampilkanData(e.target.value));
    window.onload = () => {
      loadKelas();
      tampilkanData();
    };

    function importExcel() {
      const file = document.getElementById("excelFile").files[0];
      if (!file) return alert("Pilih file Excel dahulu");
      const reader = new FileReader();
      reader.onload = function (e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: "array" });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet);
        rows.forEach(row => {
          if (row["Nama Siswa"] && row["Kelas"]) {
            const newRef = db.ref("siswa_asuh").push();
            newRef.set({
              nama: row["Nama Siswa"],
              kelas: row["Kelas"],
              guru: guruLogin
            });
          }
        });
        alert("Data berhasil diimpor.");
        setTimeout(() => window.location.reload(), 1000);
      };
      reader.readAsArrayBuffer(file);
    }

    function downloadFormat() {
      const ws = XLSX.utils.json_to_sheet([
        { "Nama Siswa": "Contoh Nama", "Kelas": "X-1", "Guru Pengampu": guruLogin }
      ]);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Format Siswa");
      XLSX.writeFile(wb, "Format_Siswa_Asuh.xlsx");
    }

    function hapusSiswa() {
      const kode = document.getElementById("kodeAkses").value;
      if (kode !== "5UGJV99QQT") return alert("Kode salah");
      const kelas = kelasDropdown.value;
      if (!kelas) return alert("Pilih kelas terlebih dahulu");
      db.ref("siswa_asuh").orderByChild("guru").equalTo(guruLogin).once("value", snapshot => {
        snapshot.forEach(child => {
          if (child.val().kelas === kelas) {
            db.ref("siswa_asuh/" + child.key).remove();
          }
        });
        alert("Siswa berhasil dihapus dari kelas " + kelas);
        setTimeout(() => window.location.reload(), 1000);
      });
    }

    function hapusKelas() {
      const kode = document.getElementById("kodeAkses").value;
      if (kode !== "5UGJV99QQT") return alert("Kode salah");
      const kelas = kelasDropdown.value;
      if (!kelas) return alert("Pilih kelas dahulu");
      db.ref("siswa_asuh").orderByChild("guru").equalTo(guruLogin).once("value", snapshot => {
        snapshot.forEach(child => {
          if (child.val().kelas === kelas) {
            db.ref("siswa_asuh/" + child.key).remove();
          }
        });
        alert("Kelas " + kelas + " berhasil dihapus.");
        setTimeout(() => window.location.reload(), 1000);
      });
    }
  </script>
</body>
</html>
