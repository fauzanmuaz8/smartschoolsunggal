<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Daftar Siswa Asuh BK</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container py-4">
  <h3 class="mb-4">Daftar Siswa Asuh BK</h3>

  <div class="mb-3">
    <label for="kelasFilter" class="form-label">Pilih Kelas:</label>
    <select class="form-select" id="kelasFilter">
      <option value="">-- Pilih Kelas --</option>
    </select>
  </div>

  <table class="table table-bordered">
    <thead>
      <tr>
        <th>Nama Siswa</th>
        <th>Kelas</th>
      </tr>
    </thead>
    <tbody id="tabelSiswa"></tbody>
  </table>

  <div class="mt-4">
    <label for="fileExcel" class="form-label">Import Siswa (Excel .xlsx):</label>
    <input type="file" id="fileExcel" class="form-control" />
  </div>

  <button class="btn btn-primary mt-2" onclick="importExcel()">Import</button>

  <button class="btn btn-warning mt-2" onclick="tambahKelas()">Tambah Kelas (Admin)</button>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBs3R8J9H6hQ96_Cm2WhWduPCK-uWJSzUo",
    authDomain: "loginsmartschool-4f57d.firebaseapp.com",
    databaseURL: "https://loginsmartschool-4f57d-default-rtdb.firebaseio.com",
    projectId: "loginsmartschool-4f57d",
    storageBucket: "loginsmartschool-4f57d.firebasestorage.app",
    messagingSenderId: "166215127727",
    appId: "1:166215127727:web:6888450f047c203871fa5a",
    measurementId: "G-8ZWH6QBTFV"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Simulasi pengguna login - nanti ini otomatis sesuai Firebase Auth
  const guruLogin = localStorage.getItem("namaGuru") || "fery"; // ambil dari localStorage

  const kelasFilter = document.getElementById("kelasFilter");
  const tabelSiswa = document.getElementById("tabelSiswa");

  // Load dropdown kelas milik guru login
  function loadKelas() {
    db.ref("kelas").once("value", (snap) => {
      kelasFilter.innerHTML = `<option value="">-- Pilih Kelas --</option>`;
      snap.forEach((child) => {
        const data = child.val();
        if (data.guru === guruLogin) {
          const opt = document.createElement("option");
          opt.value = data.nama;
          opt.textContent = data.nama;
          kelasFilter.appendChild(opt);
        }
      });
    });
  }

  // Load siswa ketika kelas dipilih
  kelasFilter.addEventListener("change", () => {
    const kelas = kelasFilter.value;
    db.ref("siswa").orderByChild("kelas").equalTo(kelas).once("value", (snap) => {
      tabelSiswa.innerHTML = "";
      snap.forEach((child) => {
        const s = child.val();
        if (s.guru === guruLogin) {
          const row = `<tr><td>${s.nama}</td><td>${s.kelas}</td></tr>`;
          tabelSiswa.innerHTML += row;
        }
      });
    });
  });

  // Tambah kelas - hanya admin
  function tambahKelas() {
    const kode = prompt("Masukkan kode admin:");
    if (kode !== "5UGJV99QQT") return alert("Kode salah!");

    const namaKelas = prompt("Nama kelas:");
    if (!namaKelas) return;

    db.ref("kelas").push({
      nama: namaKelas,
      guru: guruLogin
    }, () => {
      alert("Kelas ditambahkan!");
      loadKelas();
    });
  }

  // Import Excel siswa
  function importExcel() {
    const file = document.getElementById("fileExcel").files[0];
    if (!file) return alert("Pilih file terlebih dahulu!");

    const reader = new FileReader();
    reader.onload = function (e) {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: "array" });
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(sheet);

      json.forEach((row) => {
        if (row.Nama && row.Kelas) {
          db.ref("siswa").push({
            nama: row.Nama,
            kelas: row.Kelas,
            guru: guruLogin
          });
        }
      });

      alert("Data siswa berhasil diimpor!");
    };
    reader.readAsArrayBuffer(file);
  }

  loadKelas();
</script>
</body>
</html>
