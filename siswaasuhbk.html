<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Daftar Siswa Asuh BK</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body class="bg-light">
  <div class="container py-4">
    <h3 class="mb-3">Daftar Siswa Asuh BK</h3>

    <div class="d-flex justify-content-between mb-3">
      <div>
        <label for="kelasFilter" class="form-label">Filter Kelas:</label>
        <select id="kelasFilter" class="form-select w-auto d-inline-block"></select>
      </div>
      <div>
        <button onclick="downloadFormat()" class="btn btn-outline-primary btn-sm">Download Format Excel</button>
        <input type="file" id="importExcel" accept=".xlsx" class="form-control d-inline-block" style="width:auto;display:inline-block;">
        <button onclick="uploadExcel()" class="btn btn-success btn-sm">Import</button>
      </div>
    </div>

    <table class="table table-bordered table-striped" id="tabelSiswa">
      <thead class="table-dark">
        <tr>
          <th>No</th>
          <th>Nama Siswa</th>
          <th>Kelas</th>
        </tr>
      </thead>
      <tbody id="dataSiswa"></tbody>
    </table>

    <hr>

    <h5>Tambah / Hapus Kelas dan Siswa (Kode Akses)</h5>
    <input type="password" id="kodeAkses" class="form-control mb-2" placeholder="Masukkan kode akses (5UGJV99QQT)">
    <div class="d-flex gap-2">
      <button onclick="tambahKelas()" class="btn btn-primary btn-sm">Tambah Kelas</button>
      <button onclick="hapusKelas()" class="btn btn-danger btn-sm">Hapus Kelas</button>
      <button onclick="hapusSemuaSiswa()" class="btn btn-danger btn-sm">Hapus Semua Siswa</button>
    </div>
  </div>

  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyBs3R8J9H6hQ96_Cm2WhWduPCK-uWJSzUo",
      authDomain: "loginsmartschool-4f57d.firebaseapp.com",
      databaseURL: "https://loginsmartschool-4f57d-default-rtdb.firebaseio.com",
      projectId: "loginsmartschool-4f57d",
      storageBucket: "loginsmartschool-4f57d.appspot.com",
      messagingSenderId: "166215127727",
      appId: "1:166215127727:web:6888450f047c203871fa5a"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let guruBK = localStorage.getItem("namaGuruBK") || "fery"; // Simulasi, ambil dari index.html
    const kelasFilter = document.getElementById("kelasFilter");

    function loadKelas() {
      db.ref("kelas").once("value", (snapshot) => {
        kelasFilter.innerHTML = `<option value="">-- Semua Kelas --</option>`;
        snapshot.forEach(k => {
          const val = k.val();
          if (val.guru === guruBK) {
            const opt = document.createElement("option");
            opt.value = val.nama;
            opt.textContent = val.nama;
            kelasFilter.appendChild(opt);
          }
        });
        loadSiswa(); // muat siswa saat awal
      });
    }

    kelasFilter.addEventListener("change", loadSiswa);

    function loadSiswa() {
      const kelasDipilih = kelasFilter.value;
      db.ref("siswa").once("value", (snapshot) => {
        const tbody = document.getElementById("dataSiswa");
        tbody.innerHTML = "";
        let no = 1;
        snapshot.forEach(child => {
          const s = child.val();
          if (s.guru === guruBK && (kelasDipilih === "" || s.kelas === kelasDipilih)) {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${no++}</td>
              <td>${s.nama}</td>
              <td>${s.kelas}</td>
            `;
            tbody.appendChild(tr);
          }
        });
      });
    }

    function uploadExcel() {
      const file = document.getElementById('importExcel').files[0];
      if (!file) return alert("Pilih file Excel dulu.");
      const reader = new FileReader();
      reader.onload = (e) => {
        const workbook = XLSX.read(e.target.result, { type: 'binary' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const data = XLSX.utils.sheet_to_json(sheet);
        data.forEach(item => {
          const id = db.ref().child('siswa').push().key;
          db.ref("siswa/" + id).set({
            nama: item.nama,
            kelas: item.kelas,
            guru: guruBK
          });
        });
        alert("Berhasil diimport!");
        loadSiswa();
      };
      reader.readAsBinaryString(file);
    }

    function downloadFormat() {
      const ws = XLSX.utils.json_to_sheet([{ nama: "Budi", kelas: "X IPA 1" }]);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Format");
      XLSX.writeFile(wb, "format_siswa_asuh.xlsx");
    }

    function tambahKelas() {
      const kode = document.getElementById("kodeAkses").value;
      if (kode !== "5UGJV99QQT") return alert("Kode salah");
      const namaKelas = prompt("Masukkan nama kelas:");
      if (namaKelas) {
        const id = db.ref().child('kelas').push().key;
        db.ref("kelas/" + id).set({
          nama: namaKelas,
          guru: guruBK
        }, loadKelas);
      }
    }

    function hapusKelas() {
      const kode = document.getElementById("kodeAkses").value;
      if (kode !== "5UGJV99QQT") return alert("Kode salah");
      const konfirm = confirm("Yakin hapus semua kelas milik guru ini?");
      if (!konfirm) return;
      db.ref("kelas").once("value", snapshot => {
        snapshot.forEach(child => {
          if (child.val().guru === guruBK) {
            db.ref("kelas/" + child.key).remove();
          }
        });
        loadKelas();
      });
    }

    function hapusSemuaSiswa() {
      const kode = document.getElementById("kodeAkses").value;
      if (kode !== "5UGJV99QQT") return alert("Kode salah");
      const konfirm = confirm("Yakin hapus semua siswa milik guru ini?");
      if (!konfirm) return;
      db.ref("siswa").once("value", snapshot => {
        snapshot.forEach(child => {
          if (child.val().guru === guruBK) {
            db.ref("siswa/" + child.key).remove();
          }
        });
        loadSiswa();
      });
    }

    loadKelas();
  </script>
</body>
</html>
